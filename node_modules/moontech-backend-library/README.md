# Documentacion biblioteca back
#### Instalación

Para instalar la biblioteca, clonamos el repositorio (se puede hacer desde Visual Studio) desde [aquí](https://github.com/Moontech-Industry/moontech-backend-library)<br />
Recomiendo crear un token personal para la autenticación con Github, ya que la biblioteca se descarga de ahi. Tienes un tutorial [aquí](https://peguformiberica-my.sharepoint.com/personal/s_manea_moontech-industrial_com/_layouts/15/Doc.aspx?sourcedoc={2fc4bf0f-db82-4024-ace2-f1be47c485a3}&action=edit&wd=target%28Git.one%7Cbff9557f-360d-444a-a864-425a01aa4a79%2FA%C3%B1adir%20token%20personal%20github%20a%20npm%C2%A0%28para%20dependencias%20en%20%7C0e108969-cbcc-4830-8314-93b5b03042da%2F%29)<br />
Abrimos la terminal y hacemos
```
npm i 
```

para descargar las dependencias. <br />
En caso de persistir el error de la autenticacion, crear en la raíz del proyecto un fichero .npmrc (importante el punto) con el siguiente contenido. Este fichero no se sube al repositorio.<br />

//npm.pkg.github.com/:_authToken=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
@moontech-industry:registry=https://npm.pkg.github.com/

#### Postman

Para probar los endpoints de la biblioteca, usamos postman. Para cada endpoint, debe tener su petición correspondiente en postman.<br />
En src/scripts, hay un fichero json para importar en tu postman.<br />
Si vas añadiendo nuevos endpoints, debes añadirlo al postman y despues exportarlo en src/scripts.

#### Arrancar la biblioteca

Para arrancar la biblioteca, ejecutar el siguiente comando:
```
sudo npm run start-library
```

#### Creación nuevo módulo

Los pasos son los siguientes:
- En libs/moontech-backend-library/src, creamos una carpeta con el nombre del módulo. Creamos el módulo y todo lo necesario (controller, services, etc.)
- En moontech-backend-library.module.ts, añadimos el nuevo módulo, tanto en imports como en exports.
- En index.ts, añadir todos los elementos usados en nuestro módulo (controller, services, dto, config, etc). Este sirve para que se pueda importar desde fuera de la bibilioteca.

#### Incluir nuevas dependencias

Puede ocurrir que nuestro modulo requiera de una nueva dependencia para funcionar, por lo que para probar, se puede instalar en la propia biblioteca para testear la funcionalidad.<br />
Importante, la dependencia debe estar en el package.json dentro de libs/moontech-backend-library/src. <br />
Hasta que no esté publicado la nueva versión, en todos los backends donde este la biblioteca, no se instalará esa nueva dependencia.

#### Compilación

Para compilar la biblioteca, hay que ejecutar el siguiente comando:
```
sudo npm run build-library
```
Si todo va bien, se habra creado en dist/libs

#### Pasar a otro back para probar

Cuando tenemos nuestra bibliteca compilada, es hora de probar en otro backend, esto se hace para probar antes de publicar.
En estos proyectos, hay un fichero llamado copy-library.sh, para ejecutarlo hacemos lo siguiente:
```
./copy-library.sh
```
Importante, todos los proyectos deben estar al mismo nivel.

#### Publicación

Cuando queramos publicar una nueva versión de la biblioteca, lo primero que tenemos que hacer es cambiar el numero de version del fichero package.json en libs/moontech-backend-library/src y despues compilar la biblioteca.

El aumento de version, yo, lo realizo de la siguiente forma:
- Si se cambia de version de nest, el primer numero debe coincidir, por ejemplo: 7.1.1, estoy usando nestjs 7.
- Si agregamos un nuevo modulo, el numero intermedio aumenta.
- Si hacemos modificaciones o fixes, aumentará el último número.

Una vez compilado, realizamos el siguiente comando:
```
npm publish dist/libs/moontech-backend-library
```

No puede haber dos versiónes iguales, por lo que no es posible remplazar una versión.

Como recomendación, al publicar, crear una rama con el prefijo release con el numero de la version, por ejemplo: release/version-7_4_1



